<?php
/*
 * Controller for listing omnivalt orders and creating manifest
 * 
 * As well saving its history for futher review
 */
class ControllerOmnivaltOmnivalt extends Controller 
{
    public function index() 
    {
        $this->load->language('shipping/omnivalt');
        $this->data['heading_title'] = $this->language->get('heading_title');
        
        $numRows = $this->db->query("SELECT COUNT(*) 
                                        FROM ".DB_PREFIX."order A
                                        LEFT JOIN ".DB_PREFIX."order_omniva B ON A.order_id = B.id_order
                                        WHERE shipping_code LIKE 'omnivalt%' AND B.tracking IS NOT NULL
                                        ")->rows;
		if($numRows)								
			$numRows = intval($numRows[0]["COUNT(*)"]);
        $this->data['countRows'] = $numRows;

        if (isset($this->request->get['page'])) {
            $page = $this->request->get['page'];
         } else {
            $page = 1;
         }      
       
            $start = ($page - 1) * 50;
            $limit = 50;
         

        $pagination = new Pagination();
        $pagination->total = $numRows;
        $pagination->page = $page;
        $pagination->limit = $limit; 
        $pagination->url = $this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'] .'&page={page}', 'SSL');
      
        $this->data['pagination'] = $pagination->render();

        $orders = $this->db->query("SELECT order_id, total, date_modified, CONCAT(firstname, ' ', lastname) AS full_name, B.tracking, B.manifest, B.labels, B.id_order 
                                    FROM ".DB_PREFIX."order A
                                    LEFT JOIN ".DB_PREFIX."order_omniva B ON A.order_id = B.id_order
                                    WHERE shipping_code LIKE 'omnivalt%' AND B.tracking IS NOT NULL
                                    ORDER BY manifest DESC, order_id DESC
                                    LIMIT $start, $limit  
                                    ;");
        $newOrders = $this->db->query("SELECT order_id, total, date_modified, CONCAT(firstname, ' ', lastname) AS full_name, B.tracking, B.manifest, B.labels, B.id_order 
                                    FROM ".DB_PREFIX."order A
                                    LEFT JOIN ".DB_PREFIX."order_omniva B ON A.order_id = B.id_order
                                    WHERE shipping_code LIKE 'omnivalt%' AND B.tracking IS NULL
                                    ORDER BY order_id DESC
                                    ;");
        $this->data['newOrders'] = $newOrders->rows;


        $this->data['orders'] = $orders->rows;

		$this->data['breadcrumbs'] = array();

		$this->data['breadcrumbs'][] = array(
			'text' => $this->language->get('text_home'),
			'href' => $this->url->link('common/home', 'token=' . $this->session->data['token'], true),
      'separator' => false

		);

		$this->data['breadcrumbs'][] = array(
			'text' => $this->language->get('text_shipping'),
			'href' => $this->url->link('extension/shipping', 'token=' . $this->session->data['token'] . '&type=shipping', true),
      'separator' => false

		);
        $this->data['breadcrumbs'][] = array(
			'text' => $this->language->get('text_manifest'),
			'href' => $this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'], true),
      'separator' => false

		);
        $this->data['text_manifestHead'] = $this->language->get('text_manifestHead');
        $this->data['text_newManifest'] = $this->language->get('text_newManifest');
        $this->data['skip'] = $this->url->link('omnivalt/omnivalt/skipOrder', 'token=' . $this->session->data['token'], true);
        $this->data['cancelSkip'] = $this->url->link('omnivalt/omnivalt/cancelSkip', 'token=' . $this->session->data['token'], true);
        $this->data['button_cancel'] = $this->language->get('button_cancel');        
        $this->data['cancel'] = $this->url->link('common/home', 'token=' . $this->session->data['token'] . '&type=shipping', true);
        $this->data['client'] = $this->url->link('sale/order/info', 'token=' . $this->session->data['token'], true);
        $this->data['labels'] = $this->url->link('shipping/omnivalt/printDocs', 'token=' . $this->session->data['token'], true);
        $this->data['genLabels'] = $this->url->link('shipping/omnivalt/labels', 'token=' . $this->session->data['token'], true);
        $this->data['currentManifest'] = intval($this->config->get('omniva_manifest'));
        $this->data['newManifest'] = 'Naujas Manifestas';
        //$this->newManifest();
    $this->template = 'omnivalt/omnivalt.tpl';

    		$this->children = array(
			'common/header',
			'common/footer'
		);        
    $this->response->setOutput($this->render());
    }
    

    public function skipOrder()
    {
        if (!isset($this->request->get['order_id']))
                 $this->redirect($this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'], true));

        $id_order = $this->request->get['order_id'];
        $none = null;
        $manifest = -1;
        $this->db->query("INSERT INTO ".DB_PREFIX."order_omniva (tracking, manifest, labels, id_order)
            VALUES ('$none','$manifest','$none','$id_order')");
        
     $this->redirect($this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'], true));

    }

    public function cancelSkip()
    {
        if (!isset($this->request->get['order_id']))
                 $this->redirect($this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'], true));

        $id_order = $this->request->get['order_id'];
        $none = null;
        $this->db->query("DELETE FROM ".DB_PREFIX."order_omniva WHERE id_order=".$id_order." AND manifest=-1;");

        
     $this->redirect($this->url->link('omnivalt/omnivalt', 'token=' . $this->session->data['token'], true));

    }

}